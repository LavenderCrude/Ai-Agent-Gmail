<!DOCTYPE html>
<html lang="en" class="scroll-smooth">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>AI Email Dashboard</title>
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.min.js"></script>

    <style>
      :root {
        --bg: #f8fafc;
        --card: #fff;
        --text: #1e293b;
        --border: #e2e8f0;
        --header-bg: rgba(255, 255, 255, 0.1);
      }
      .dark {
        --bg: #0b1120;
        --card: #1e293b;
        --text: #e2e8f0;
        --border: #334155;
        --header-bg: rgba(15, 23, 42, 0.7);
      }
      body {
        background: var(--bg);
        color: var(--text);
        transition: all 0.3s;
      }
      .card {
        background: var(--card);
        border: 1px solid var(--border);
      }
      .glass {
        backdrop-filter: blur(12px);
        background: var(--header-bg);
        border: 1px solid rgba(255, 255, 255, 0.1);
      }

      #toast {
        position: fixed;
        bottom: 2rem;
        right: 2rem;
        min-width: 280px;
        background: #10b981;
        color: white;
        padding: 1rem 1.5rem;
        border-radius: 0.75rem;
        box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        transform: translateY(120%);
        opacity: 0;
        transition: all 0.3s ease;
        z-index: 1000;
        display: flex;
        align-items: center;
        gap: 0.75rem;
      }
      #toast.show {
        transform: translateY(0);
        opacity: 1;
      }

      .line-clamp-2 {
        overflow: hidden;
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
      }
    </style>
  </head>
  <body class="min-h-screen">
    <!-- Header -->
    <header class="glass sticky top-0 z-50 border-b border-white/20">
      <div
        class="max-w-7xl mx-auto px-6 py-4 flex justify-between items-center"
      >
        <div class="flex items-center gap-3">
          <i data-lucide="mail" class="w-8 h-8 text-indigo-500"></i>
          <h1 class="text-2xl font-bold text-indigo-600 dark:text-indigo-400">
            AI Email Agent
          </h1>
        </div>
        <div class="flex gap-2">
          <button
            id="refreshBtn"
            class="p-2 rounded-lg hover:bg-white/20 transition"
            title="Refresh"
          >
            <i data-lucide="refresh-cw" class="w-5 h-5"></i>
          </button>
          <button
            id="darkToggle"
            class="p-2 rounded-lg hover:bg-white/20 transition"
          >
            <i data-lucide="moon" class="w-5 h-5 hidden dark:inline"></i>
            <i data-lucide="sun" class="w-5 h-5 dark:hidden"></i>
          </button>
        </div>
      </div>
    </header>

    <div class="max-w-7xl mx-auto p-6 space-y-6">
      <!-- Stats -->
      <div class="grid grid-cols-1 md:grid-cols-5 gap-4">
        <div class="card p-5 rounded-xl shadow-sm">
          <p class="text-sm text-gray-600 dark:text-gray-400">Total</p>
          <p
            id="total"
            class="text-2xl font-bold text-indigo-600 dark:text-indigo-400"
          >
            0
          </p>
        </div>
        <div class="card p-5 rounded-xl shadow-sm">
          <p class="text-sm text-gray-600 dark:text-gray-400">Interviews</p>
          <p
            id="interview"
            class="text-2xl font-bold text-purple-600 dark:text-purple-400"
          >
            0
          </p>
        </div>
        <div class="card p-5 rounded-xl shadow-sm">
          <p class="text-sm text-gray-600 dark:text-gray-400">Meetings</p>
          <p
            id="meeting"
            class="text-2xl font-bold text-blue-600 dark:text-blue-400"
          >
            0
          </p>
        </div>
        <div class="card p-5 rounded-xl shadow-sm">
          <p class="text-sm text-gray-600 dark:text-gray-400">Important</p>
          <p
            id="important"
            class="text-2xl font-bold text-yellow-600 dark:text-yellow-400"
          >
            0
          </p>
        </div>
        <div class="card p-5 rounded-xl shadow-sm">
          <p class="text-sm text-gray-600 dark:text-gray-400">Others</p>
          <p
            id="other"
            class="text-2xl font-bold text-gray-600 dark:text-gray-400"
          >
            0
          </p>
        </div>
      </div>

      <!-- Search -->
      <div class="card p-4 rounded-xl shadow-sm">
        <div class="flex gap-3">
          <div class="flex-1 relative">
            <i
              data-lucide="search"
              class="absolute left-3 top-3 w-5 h-5 text-gray-400"
            ></i>
            <input
              id="search"
              placeholder="Search subject, sender, body..."
              class="w-full pl-10 pr-4 py-3 rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-800 text-gray-900 dark:text-gray-100 focus:ring-2 focus:ring-indigo-500 outline-none transition"
            />
          </div>
        </div>
      </div>

      <!-- Email List -->
      <div id="emailContainer" class="space-y-4">
        <p class="text-center text-gray-500 py-12" id="empty">
          No emails yet. Run your agent!
        </p>
      </div>
    </div>

    <!-- Toast -->
    <div id="toast">
      <i data-lucide="mail" class="w-5 h-5"></i><span>New email received!</span>
    </div>

    <!-- Modal -->
    <div
      id="modal"
      class="fixed inset-0 bg-black/50 hidden z-50 flex items-center justify-center p-4"
    >
      <div
        class="card max-w-4xl w-full max-h-[90vh] overflow-y-auto p-6 rounded-xl"
      >
        <div class="flex justify-between items-start mb-4">
          <h2 id="modalSubject" class="text-xl font-bold"></h2>
          <button
            id="closeModal"
            class="p-1 hover:bg-gray-200 dark:hover:bg-gray-700 rounded"
          >
            <i data-lucide="x" class="w-5 h-5"></i>
          </button>
        </div>
        <p><strong>From:</strong> <span id="modalFrom"></span></p>
        <p><strong>Date:</strong> <span id="modalDate"></span></p>
        <p>
          <strong>Category:</strong>
          <span
            id="modalCategory"
            class="px-2 py-1 text-xs rounded-full"
          ></span>
        </p>
        <div class="mt-4 p-4 bg-gray-50 dark:bg-gray-800 rounded">
          <p id="modalBody" class="whitespace-pre-wrap"></p>
        </div>
        <div id="modalReply" class="mt-4"></div>
        <div id="modalCalendar" class="mt-4"></div>
        <p
          class="mt-4 text-sm text-gray-600 dark:text-gray-400"
          id="modalStatus"
        ></p>
        <button
          id="deleteBtn"
          class="mt-4 px-4 py-2 bg-red-600 text-white rounded hover:bg-red-700 transition"
        >
          Delete from Database
        </button>
      </div>
    </div>

    <script>
      lucide.createIcons();
      const socket = io();
      const container = document.getElementById('emailContainer');
      const empty = document.getElementById('empty');
      const modal = document.getElementById('modal');
      const toast = document.getElementById('toast');
      let allEmails = [],
        currentEmail = null;

      // Dark mode
      const html = document.documentElement;
      if (
        localStorage.theme === 'dark' ||
        (!localStorage.theme &&
          window.matchMedia('(prefers-color-scheme: dark)').matches)
      )
        html.classList.add('dark');
      document.getElementById('darkToggle').onclick = () => {
        html.classList.toggle('dark');
        localStorage.theme = html.classList.contains('dark') ? 'dark' : 'light';
      };

      // Toast
      const showToast = () => {
        toast.classList.add('show');
        setTimeout(() => toast.classList.remove('show'), 3000);
      };

      // Refresh button
      document.getElementById('refreshBtn').onclick = () =>
        fetch('/api/refresh', { method: 'POST' }).then(load);

      // Search
      document
        .getElementById('search')
        .addEventListener('input', (e) => filter(e.target.value));
      const filter = (q) => {
        const l = q.toLowerCase();
        const f = allEmails.filter(
          (e) =>
            e.subject.toLowerCase().includes(l) ||
            e.from.toLowerCase().includes(l) ||
            e.body.toLowerCase().includes(l)
        );
        render(f);
      };

      // Render
      const render = (emails) => {
        if (!emails.length) {
          empty.classList.remove('hidden');
          container.innerHTML = '';
          return;
        }
        empty.classList.add('hidden');
        container.innerHTML = '';
        emails.forEach((e) => {
          const card = document.createElement('div');
          card.className =
            'card p-6 rounded-xl shadow hover:shadow-md transition cursor-pointer';
          card.onclick = () => openModal(e);
          const cat =
            {
              interview:
                'bg-purple-100 text-purple-700 dark:bg-purple-900 dark:text-purple-300',
              meeting:
                'bg-blue-100 text-blue-700 dark:bg-blue-900 dark:text-blue-300',
              important_email:
                'bg-yellow-100 text-yellow-700 dark:bg-yellow-900 dark:text-yellow-300',
              not_important:
                'bg-gray-100 text-gray-600 dark:bg-gray-700 dark:text-gray-400',
              other:
                'bg-gray-100 text-gray-600 dark:bg-gray-700 dark:text-gray-400',
            }[e.ai_category] ||
            'bg-gray-100 text-gray-600 dark:bg-gray-700 dark:text-gray-400';
          card.innerHTML = `
          <div class="flex justify-between items-start">
            <div class="flex-1">
              <h3 class="font-semibold text-lg text-gray-900 dark:text-gray-100 line-clamp-1">${
                e.subject
              }</h3>
              <p class="text-sm text-gray-600 dark:text-gray-400 mt-1">From: ${
                e.from
              }</p>
              <p class="text-xs text-gray-500 dark:text-gray-500 mt-2">${new Date(
                e.processed_at * 1000
              ).toLocaleString()}</p>
            </div>
            <div class="flex gap-2 items-center">
              <span class="px-3 py-1 text-xs font-medium rounded-full ${cat}">${
            e.ai_category
          }</span>
              ${
                e.ai_reply
                  ? '<i data-lucide="check-circle" class="w-5 h-5 text-green-500"></i>'
                  : ''
              }
            </div>
          </div>
          <p class="mt-3 text-sm text-gray-700 dark:text-gray-300 line-clamp-2">${
            e.body
          }</p>`;
          container.appendChild(card);
        });
        lucide.createIcons();
      };

      // Modal
      const openModal = (e) => {
        currentEmail = e;
        document.getElementById('modalSubject').textContent = e.subject;
        document.getElementById('modalFrom').textContent = e.from;
        document.getElementById('modalDate').textContent = new Date(
          e.processed_at * 1000
        ).toLocaleString();
        document.getElementById('modalCategory').textContent = e.ai_category;
        const b = document.getElementById('modalCategory');
        b.className = `px-2 py-1 text-xs rounded-full ${
          {
            interview: 'bg-purple-100 text-purple-700',
            meeting: 'bg-blue-100 text-blue-700',
            important_email: 'bg-yellow-100 text-yellow-700',
            not_important: 'bg-gray-100 text-gray-600',
            other: 'bg-gray-100 text-gray-600',
          }[e.ai_category]
        }`;
        document.getElementById('modalBody').textContent = e.body;
        document.getElementById('modalStatus').textContent =
          e.action_status || '';
        const r = document.getElementById('modalReply');
        r.innerHTML = e.ai_reply
          ? `<p class="font-semibold text-green-700 dark:text-green-400">AI Reply:</p><pre class="p-3 bg-green-50 dark:bg-green-900/30 rounded mt-1 text-sm overflow-x-auto">${e.ai_reply.body}</pre>`
          : '<p class="text-gray-500">No reply sent.</p>';
        const c = document.getElementById('modalCalendar');
        c.innerHTML = e.calendar_link
          ? `<p class="font-semibold text-blue-700 dark:text-blue-400">Calendar Event:</p><a href="${e.calendar_link}" target="_blank" class="text-blue-600 underline text-sm">Open in Google Calendar</a>`
          : '<p class="text-gray-500">No calendar event.</p>';
        modal.classList.remove('hidden');
      };
      document.getElementById('closeModal').onclick = () =>
        modal.classList.add('hidden');

      // Delete
      document.getElementById('deleteBtn').onclick = () => {
        if (!confirm('Delete this email from database?')) return;
        fetch(`/api/delete/${currentEmail._id}`, { method: 'DELETE' })
          .then((r) => r.json())
          .then((d) => {
            if (d.success) {
              modal.classList.add('hidden');
              load();
            } else alert('Delete failed');
          })
          .catch(() => alert('Network error'));
      };

      // Load
      const load = async () => {
        const [eRes, sRes] = await Promise.all([
          fetch('/api/emails'),
          fetch('/api/stats'),
        ]);
        const emails = await eRes.json();
        const stats = await sRes.json();
        allEmails = emails;
        render(emails);
        document.getElementById('total').textContent = stats.total;
        document.getElementById('interview').textContent =
          stats.categories.interview;
        document.getElementById('meeting').textContent =
          stats.categories.meeting;
        document.getElementById('important').textContent =
          stats.categories.important_email;
        document.getElementById('other').textContent = stats.categories.other;
      };

      // Socket: NEW EMAIL â†’ toast + refresh
      socket.on('connect', load);
      socket.on('new_email', () => {
        showToast();
        load();
      });
      socket.on('refresh', load); // delete / manual refresh

      load();
    </script>
  </body>
</html>
